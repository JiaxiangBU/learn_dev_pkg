---
title:  R 开发包 Cookbook
author: 李家翔
date: "`r Sys.Date()`"
output: 
    bookdown::gitbook:
        split_by: none
        split_bib: TRUE
        df_print: paged
bibliography: refs/add.bib
---

```{r setup,echo = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

<!-- Place this tag in your head or just before your close body tag. -->
<script async defer src="https://buttons.github.io/buttons.js"></script>

1. 使用 RMarkdown 的 `child` 参数，进行文档拼接。
1. 这样拼接以后的笔记方便复习。
1. 相关问题提交到
    <a class="github-button" href="https://github.com/JiaxiangBU/tutoring2/issues" data-show-count="true" aria-label="Issue JiaxiangBU/tutoring on GitHub">Issue</a>

# 完成状态

```r
-- R CMD check results --------------------------------------- add2md 1.1.0 ----
Duration: 51.8s

0 errors �� | 0 warnings �� | 0 notes ��
Warning in readChar(path, nchars = file.info(path)$size, ...) :
  ��non-UTF-8 MBCS���Ի�����ֻ�ܶ�ȡ�ֽ�

R CMD check succeeded
```

```r
0 errors �� | 0 warnings �� | 0 notes ��
```

体现了包可以上传了。

# 函数缺少引用

```r
> checking R code for possible problems ... NOTE
  get_output: no visible global function definition for 'mutate'
  get_url: no visible global function definition for 'map_chr'
  Undefined global functions or variables:
    map_chr mutate

0 errors �� | 2 warnings x | 2 notes x
Warning in readChar(path, nchars = file.info(path)$size, ...) :
  ��non-UTF-8 MBCS���Ի�����ֻ�ܶ�ȡ�ֽ�
����: R CMD check found WARNINGs
ִֹͣ��

Exited with status 1.
```

加上 rer 的包名称。如 `mutate` 加上 `dplyr::`

# ignore 额外文件夹

```r
> checking top-level files ... NOTE
  Non-standard file/directory found at top level:
    'depreciated'
```

```r
use_build_ignore("depreciated")
```

# 使用 Unicode

参考 https://stackoverflow.com/a/22224027/8625228

```r
-- R CMD check results --------------------------------------- add2md 1.1.0 ----
Duration: 56.7s

> checking R files for non-ASCII characters ... WARNING
  Found the following file with non-ASCII characters:
    paste_kindle.R
  Portable packages must use only ASCII characters in their R code,
  except perhaps in comments.
  Use \uxxxx escapes for other characters.
```

```r
clipr::read_clip() %>% stringi::stri_escape_unicode() %>% clipr::write_clip()
```

# vignette 报错

```r
E  creating vignettes (13.4s)
   --- re-building 'introduction.Rmd' using rmarkdown
   Quitting from lines 228-229 (introduction.Rmd) 
   Error: processing vignette 'introduction.Rmd' failed with diagnostics:
   û��"relative_path"�������
   --- failed re-building 'introduction.Rmd'
   
   --- re-building 'url.Rmd' using rmarkdown
   --- finished re-building 'url.Rmd'
   
   SUMMARY: processing the following file failed:
     'introduction.Rmd'
   
   ����: Vignette re-building failed.
   ִֹͣ��
Error in (function (command = NULL, args = character(), error_on_status = TRUE,  : 
  System command error
Calls: <Anonymous> ... eval -> with_envvar -> force -> do.call -> <Anonymous>
ִֹͣ��

Exited with status 1.
```

删除 depreciated 的函数

# use_package

```r
> checking package dependencies ... ERROR
  Namespace dependencies not required:
    'clipr', 'glue', 'rstudioapi', 'rvest', 'usethis', 'xml2'
  
  See section 'The DESCRIPTION file' in the 'Writing R Extensions'
  manual.

1 error x | 0 warnings <U+2713> | 0 notes <U+2713>
```

复制 `'clipr', 'glue', 'rstudioapi', 'rvest', 'usethis', 'xml2'`

```r
c('clipr', 'glue', 'rstudioapi', 'rvest', 'usethis', 'xml2') %>% 
    purrr::walk(usethis::use_package)
```

# 去除 library

```r
> checking dependencies in R code ... WARNING
  '::' or ':::' imports not declared from:
    'here' 'readr' 'stringr' 'yaml'
```

直接在 utils 加入
复制 `'here' 'readr' 'stringr' 'yaml'`

```r
"'here' 'readr' 'stringr' 'yaml'" %>% 
    str_split(" ") %>% 
    .[[1]] %>% 
    str_remove_all("'") %>% 
    paste("#' @import", .) %>% 
    str_flatten("\n") %>% 
    clipr::write_clip()
```

然后增加

```r
c('here', 'readr', 'stringr', 'yaml') %>% 
    purrr::walk(usethis::use_package)
```

# 函数缺少描述

```r

> checking for missing documentation entries ... WARNING
  Undocumented code objects:
    'm1_v2'
  All user-level objects in a package should have documentation entries.
  See chapter 'Writing R documentation files' in the 'Writing R
  Extensions' manual.
```

add

```r
#' Build a url in markdown
#'
#' This function helps users to paste url in markdown
#'
#' @param size the figure size, by default, 100 x 100
#' @return Character.
#' @author Jiaxiang Li
#'
#' @import rstudioapi
#' @importFrom stringr str_split str_match str_detect
#' @importFrom glue glue
#' @importFrom rebus %R% or DOT one_or_more LOWER optional capture END
#' @export
```

# 函数参数缺少描述

```r
> checking Rd \usage sections ... WARNING
  Undocumented arguments in documentation object 'build_iframe'
    'input' 'is_nbviewer'
  Documented arguments not in \usage in documentation object 'build_iframe':
    'url'

```

```r
#' @param input character. URL.
#' @param is_nbviewer logical. Whether the url is Jupyter notebook.
```

```r
  Undocumented arguments in documentation object 'button'
    '...'
  
  Undocumented arguments in documentation object 'center'
    'input' 'size'
  
  Undocumented arguments in documentation object 'change_to_upper'
    'input'
  
  Undocumented arguments in documentation object 'checkbox'
    'input'
  
  Undocumented arguments in documentation object 'extract_firstline'
    'url' 'content_path' 'pattern' 'para_length'
  
  Undocumented arguments in documentation object 'extract_highlight'
    'url' 'pattern'
  
  Undocumented arguments in documentation object 'get_input'
    'input' 'clip' 'collapse'
  
  Undocumented arguments in documentation object 'get_quote'
    'input'
  
  Undocumented arguments in documentation object 'get_url'
    'input' 'name'
  
  Undocumented arguments in documentation object 'get_url_title'
    'url'
  
  Undocumented arguments in documentation object 'get_word_style'
    'style'
  
  Undocumented arguments in documentation object 'kbd'
    '...'
  
  Undocumented arguments in documentation object 'list_in_order'
    'input'
  
  Undocumented arguments in documentation object 'mark'
    '...'
  
  Undocumented arguments in documentation object 'naming_dir'
    'input' 'sep'
  
  Undocumented arguments in documentation object 'transfer2df'
    'raw_text'
  Documented arguments not in \usage in documentation object 'transfer2df':
    'size'
  
  Functions with \usage entries need to have the appropriate \alias
  entries, and all their arguments documented.
  The \usage entries must correspond to syntactically valid R code.
  See chapter 'Writing R documentation files' in the 'Writing R
  Extensions' manual.
```

一个个添加好

没有 `@export` 函数，如果增加了多余的参数，也会报错。

# packrat 删除

```r

> checking if this is a source package ... NOTE
  Subdirectory 'packrat/lib/x86_64-apple-darwin15.6.0/3.5.1/packrat' seems to contain an installed version of the package.
```

直接删除。

# 添加 global 变量

```r
> checking R code for possible problems ... NOTE
  add_zenodo_citation: no visible binding for global variable '.'
  Undefined global functions or variables:
    .

0 errors <U+2713> | 1 warning x | 2 notes x
```

`globalVariables('.')`

# 更新 NEWS.md


```{r,child="analysis/update_news.Rmd"}
```


# CRAN Comments

1. `use_cran_comments()`
1. `use_build_ignore("cran-comments.md")`

创建如下

```r
## Test environments
* local OS X install, R 3.6.0
* ubuntu 14.04 (on travis-ci), R 3.6.0
* win-builder (devel and release)

## R CMD check results

0 errors | 0 warnings | 1 note

* This is a new release.
```


# Ignore README.Rmd

参考 https://stackoverflow.com/a/48956446/8625228

```r
> checking top-level files ... NOTE
  Non-standard file/directory found at top level:
    'README.Rmd'
```

`usethis::use_build_ignore("README.Rmd")` 

# Update DESC

```r
> checking DESCRIPTION meta-information ... NOTE
  Malformed Description field: should contain one or more complete sentences.
```

```r
Description: Some helper functions for R package development,
    including create disclaimer, author information and so on.
```

# 附录 {-}

# 参考文献 {-}
