---
title:  R 开发包 Cookbook
author: 李家翔
date: "`r Sys.Date()`"
output: 
    bookdown::gitbook:
        split_by: none
        split_bib: TRUE
        df_print: paged
bibliography: refs/add.bib
---

```{r setup,echo = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

<!-- Place this tag in your head or just before your close body tag. -->
<script async defer src="https://buttons.github.io/buttons.js"></script>

1. 使用 RMarkdown 的 `child` 参数，进行文档拼接。
1. 这样拼接以后的笔记方便复习。
1. 相关问题提交到
    <a class="github-button" href="https://github.com/JiaxiangBU/tutoring2/issues" data-show-count="true" aria-label="Issue JiaxiangBU/tutoring on GitHub">Issue</a>

# 完成状态

```r
-- R CMD check results --------------------------------------- add2md 1.1.0 ----
Duration: 51.8s

0 errors �� | 0 warnings �� | 0 notes ��
Warning in readChar(path, nchars = file.info(path)$size, ...) :
  ��non-UTF-8 MBCS���Ի�����ֻ�ܶ�ȡ�ֽ�

R CMD check succeeded
```

```r
0 errors �� | 0 warnings �� | 0 notes ��
```

体现了包可以上传了。

# 函数缺少引用

```r
> checking R code for possible problems ... NOTE
  get_output: no visible global function definition for 'mutate'
  get_url: no visible global function definition for 'map_chr'
  Undefined global functions or variables:
    map_chr mutate

0 errors �� | 2 warnings x | 2 notes x
Warning in readChar(path, nchars = file.info(path)$size, ...) :
  ��non-UTF-8 MBCS���Ի�����ֻ�ܶ�ȡ�ֽ�
����: R CMD check found WARNINGs
ִֹͣ��

Exited with status 1.
```

加上 rer 的包名称。如 `mutate` 加上 `dplyr::`

# ignore 额外文件夹

```r
> checking top-level files ... NOTE
  Non-standard file/directory found at top level:
    'depreciated'
```

```r
use_build_ignore("depreciated")
```

# 使用 Unicode

参考 https://stackoverflow.com/a/22224027/8625228

```r
-- R CMD check results --------------------------------------- add2md 1.1.0 ----
Duration: 56.7s

> checking R files for non-ASCII characters ... WARNING
  Found the following file with non-ASCII characters:
    paste_kindle.R
  Portable packages must use only ASCII characters in their R code,
  except perhaps in comments.
  Use \uxxxx escapes for other characters.
```

```r
clipr::read_clip() %>% stringi::stri_escape_unicode() %>% clipr::write_clip()
```

# vignette 报错

```r
E  creating vignettes (13.4s)
   --- re-building 'introduction.Rmd' using rmarkdown
   Quitting from lines 228-229 (introduction.Rmd) 
   Error: processing vignette 'introduction.Rmd' failed with diagnostics:
   û��"relative_path"�������
   --- failed re-building 'introduction.Rmd'
   
   --- re-building 'url.Rmd' using rmarkdown
   --- finished re-building 'url.Rmd'
   
   SUMMARY: processing the following file failed:
     'introduction.Rmd'
   
   ����: Vignette re-building failed.
   ִֹͣ��
Error in (function (command = NULL, args = character(), error_on_status = TRUE,  : 
  System command error
Calls: <Anonymous> ... eval -> with_envvar -> force -> do.call -> <Anonymous>
ִֹͣ��

Exited with status 1.
```

删除 depreciated 的函数

# use_package

```r
> checking package dependencies ... ERROR
  Namespace dependencies not required:
    'clipr', 'glue', 'rstudioapi', 'rvest', 'usethis', 'xml2'
  
  See section 'The DESCRIPTION file' in the 'Writing R Extensions'
  manual.

1 error x | 0 warnings <U+2713> | 0 notes <U+2713>
```

复制 `'clipr', 'glue', 'rstudioapi', 'rvest', 'usethis', 'xml2'`

```r
c('clipr', 'glue', 'rstudioapi', 'rvest', 'usethis', 'xml2') %>% 
    purrr::walk(usethis::use_package)
```

# 去除 library

```r
> checking dependencies in R code ... WARNING
  '::' or ':::' imports not declared from:
    'here' 'readr' 'stringr' 'yaml'
```

直接在 utils 加入
复制 `'here' 'readr' 'stringr' 'yaml'`

```r
"'here' 'readr' 'stringr' 'yaml'" %>% 
    str_split(" ") %>% 
    .[[1]] %>% 
    str_remove_all("'") %>% 
    paste("#' @import", .) %>% 
    str_flatten("\n") %>% 
    clipr::write_clip()
```

然后增加

```r
c('here', 'readr', 'stringr', 'yaml') %>% 
    purrr::walk(usethis::use_package)
```

# 函数缺少描述

```r

> checking for missing documentation entries ... WARNING
  Undocumented code objects:
    'm1_v2'
  All user-level objects in a package should have documentation entries.
  See chapter 'Writing R documentation files' in the 'Writing R
  Extensions' manual.
```

add

```r
#' Build a url in markdown
#'
#' This function helps users to paste url in markdown
#'
#' @param size the figure size, by default, 100 x 100
#' @return Character.
#' @author Jiaxiang Li
#'
#' @import rstudioapi
#' @importFrom stringr str_split str_match str_detect
#' @importFrom glue glue
#' @importFrom rebus %R% or DOT one_or_more LOWER optional capture END
#' @export
```

# 函数参数缺少描述

```r
> checking Rd \usage sections ... WARNING
  Undocumented arguments in documentation object 'build_iframe'
    'input' 'is_nbviewer'
  Documented arguments not in \usage in documentation object 'build_iframe':
    'url'

```

```r
#' @param input character. URL.
#' @param is_nbviewer logical. Whether the url is Jupyter notebook.
```

```r
  Undocumented arguments in documentation object 'button'
    '...'
  
  Undocumented arguments in documentation object 'center'
    'input' 'size'
  
  Undocumented arguments in documentation object 'change_to_upper'
    'input'
  
  Undocumented arguments in documentation object 'checkbox'
    'input'
  
  Undocumented arguments in documentation object 'extract_firstline'
    'url' 'content_path' 'pattern' 'para_length'
  
  Undocumented arguments in documentation object 'extract_highlight'
    'url' 'pattern'
  
  Undocumented arguments in documentation object 'get_input'
    'input' 'clip' 'collapse'
  
  Undocumented arguments in documentation object 'get_quote'
    'input'
  
  Undocumented arguments in documentation object 'get_url'
    'input' 'name'
  
  Undocumented arguments in documentation object 'get_url_title'
    'url'
  
  Undocumented arguments in documentation object 'get_word_style'
    'style'
  
  Undocumented arguments in documentation object 'kbd'
    '...'
  
  Undocumented arguments in documentation object 'list_in_order'
    'input'
  
  Undocumented arguments in documentation object 'mark'
    '...'
  
  Undocumented arguments in documentation object 'naming_dir'
    'input' 'sep'
  
  Undocumented arguments in documentation object 'transfer2df'
    'raw_text'
  Documented arguments not in \usage in documentation object 'transfer2df':
    'size'
  
  Functions with \usage entries need to have the appropriate \alias
  entries, and all their arguments documented.
  The \usage entries must correspond to syntactically valid R code.
  See chapter 'Writing R documentation files' in the 'Writing R
  Extensions' manual.
```

一个个添加好

没有 `@export` 函数，如果增加了多余的参数，也会报错。

# packrat 删除

```r

> checking if this is a source package ... NOTE
  Subdirectory 'packrat/lib/x86_64-apple-darwin15.6.0/3.5.1/packrat' seems to contain an installed version of the package.
```

直接删除。

# 添加 global 变量

```r
> checking R code for possible problems ... NOTE
  add_zenodo_citation: no visible binding for global variable '.'
  Undefined global functions or variables:
    .

0 errors <U+2713> | 1 warning x | 2 notes x
```

`globalVariables('.')`

# 更新 NEWS.md


```{r,child="analysis/update_news.Rmd"}
```


# CRAN Comments

1. `use_cran_comments()`
1. `use_build_ignore("cran-comments.md")`

创建如下

```r
## Test environments
* local OS X install, R 3.6.0
* ubuntu 14.04 (on travis-ci), R 3.6.0
* win-builder (devel and release)

## R CMD check results

0 errors | 0 warnings | 1 note

* This is a new release.
```


# Ignore README.Rmd

参考 https://stackoverflow.com/a/48956446/8625228

```r
> checking top-level files ... NOTE
  Non-standard file/directory found at top level:
    'README.Rmd'
```

`usethis::use_build_ignore("README.Rmd")` 

# Update DESC

```r
> checking DESCRIPTION meta-information ... NOTE
  Malformed Description field: should contain one or more complete sentences.
```

```r
Description: Some helper functions for R package development,
    including create disclaimer, author information and so on.
```

# 保证 README.Rmd 链接都是有效的

```r
New submission
 
  Found the following (possibly) invalid file URIs:
    URI: .github/CODE_OF_CONDUCT.md
      From: README.md
    URI: LICENSE.md
      From: README.md
```

# Add test and vignettes

```r
Flavor: r-devel-linux-x86_64-debian-gcc, r-devel-windows-ix86+x86_64
Check: for code which exercises the package, Result: WARNING
  No examples, no tests, no vignettes
```

```r
> usethis::use_test("add_me")
✔ Setting active project to 'D:/work/add2pkg'
✔ Adding 'testthat' to Suggests field in DESCRIPTION
✔ Creating 'tests/testthat/'
✔ Writing 'tests/testthat.R'
● Call `use_test()` to initialize a basic test file and open it for editing.
✔ Increasing 'testthat' version to '>= 2.1.0' in DESCRIPTION
✔ Writing 'tests/testthat/test-add_me.R'
● Modify 'tests/testthat/test-add_me.R'
```

加上 test

```r
test_that("Plain Text", {
  expect_equal(add_me(), 'Authors@R:
    person(given = "Jiaxiang",
           family = "Li",
           role = c("aut", "cre"),
           email = "alex.lijiaxiang@foxmail.com",
           comment = c(ORCID = "https://orcid.org/0000-0003-3196-6492"))')
})
```

加上 vignette

```r
> use_vignette("intro")
✔ Adding 'knitr' to Suggests field in DESCRIPTION
✔ Setting VignetteBuilder field in DESCRIPTION to 'knitr'
✔ Adding 'inst/doc' to '.gitignore'
✔ Creating 'vignettes/'
✔ Adding '*.html', '*.R' to 'vignettes/.gitignore'
✔ Adding 'rmarkdown' to Suggests field in DESCRIPTION
✔ Writing 'vignettes/intro.Rmd'
● Modify 'vignettes/intro.Rmd'
```


```r
add_me()
```

```r
add_disclaimer()
```

# release 函数的流程

```r
> devtools::release()
Warning: DR_DEVTOOLS FOUND PROBLEMS
* R is out of date (3.6.0 vs 3.6.2)
* Devtools or dependencies out of date: devtools, callr, cli, covr, digest, DT, httr,
  pkgbuild, rlang, roxygen2, testthat, curl, whisker, R6, Rcpp, backports, mime,
  openssl, sys, processx, fansi, rex, htmlwidgets, ggplot2, scales, BH, plyr, pillar,
  pkgconfig, vctrs, stringi, prettyunits, xml2
* RStudio is out of date (1.2.5001 vs 1.2.5033.1)
Proceed anyway?
1: I forget
2: Not yet
3: Yup

Selection: 3
Have you checked for spelling errors (with `spell_check()`)?
1: I forget
2: For sure
3: No way

Selection: 2
Have you run `R CMD check` locally?
1: Yup
2: Not yet
3: No way

Selection: 1
── Running additional devtools checks for add2pkg ──────────────────────────────
Checking version number has three components... OK
Checking dependencies don't rely on dev versions... OK
Checking vignette titles are not placeholders... OK
Checking NEWS.md is not ignored... OK
Checking NEWS.Rd does not exist... OK
Checking DESCRIPTION doesn't have Remotes field... OK
────────────────────────────────────────────────────────────────────────────────
Were devtool's checks successful?
1: Not yet
2: Definitely
3: No

Selection: 2
Have you checked on R-hub (with `check_rhub()`)?
1: No way
2: I forget
3: Definitely

Selection: 3
Have you checked on win-builder (with `check_win_devel()`)?
1: No way
2: Definitely
3: No

Selection: 2
Have you updated `NEWS.md` file?
1: Yeah
2: Nope
3: Uhhhh... Maybe?

Selection: 1
Have you updated `DESCRIPTION`?
1: No way
2: For sure
3: Nope

Selection: 2
Have you updated `cran-comments.md?`
1: Of course
2: Uhhhh... Maybe?
3: Not yet

Selection: 1
── Running Git checks for add2pkg ──────────────────────────────────────────────
Checking uncommitted files... OK
Checking synchronisation with remote branch... OK
────────────────────────────────────────────────────────────────────────────────
Were Git checks successful?
1: Not yet
2: Yup
3: Uhhhh... Maybe?

Selection: 2
Is your email address alex.lijiaxiang@foxmail.com?
1: No
2: Absolutely
3: Uhhhh... Maybe?

Selection: 2
Building
pdflatex not found! Not building PDF manual.
✓  checking for file 'D:\work\add2pkg/DESCRIPTION' (499ms)
─  preparing 'add2pkg': (1.1s)
✓  checking DESCRIPTION meta-information ... OK
─  installing the package to build vignettes
✓  creating vignettes (7s)
─  checking for LF line-endings in source and make files and shell scripts (352ms)
─  checking for empty or unneeded directories
─  building 'add2pkg_0.2.1.tar.gz'
   
Submitting file: C:\Users\LIJIAX~1\AppData\Local\Temp\RtmpEdl715/add2pkg_0.2.1.tar.gz
File size: 7.9 Kb
Ready to submit add2pkg (0.2.1) to CRAN?
1: Yes
2: No way
3: Uhhhh... Maybe?

Selection: 1
Uploading package & comments
Confirming submission
Error in if (new_url$query$submit == "1") { : argument is of length zero
```

# r-hub 通过示例

![image](https://user-images.githubusercontent.com/15884785/72242811-435bc900-3625-11ea-8ef2-521cf436792b.png)

地址 https://builder.r-hub.io/status/original/add2pkg_0.2.1.tar.gz-76c7b9d1252c2906bea2aeb92441ec27

# 上传成功后的邮件

```
Dear maintainer,
 
package add2pkg_0.2.1.tar.gz has been auto-processed and is pending a manual inspection of this new CRAN submission. A CRAN team member will typically respond to you within the next 10 working days. For technical reasons you may receive a second copy of this message when a team member triggers a new check.
 
Log dir: <https://win-builder.r-project.org/incoming_pretest/add2pkg_0.2.1_20200113_095008/>;
The files will be removed after roughly 7 days.
Installation time in seconds: 25
Check time in seconds: 144
R Under development (unstable) (2020-01-07 r77633)
 
Pretests results:
Windows: <https://win-builder.r-project.org/incoming_pretest/add2pkg_0.2.1_20200113_095008/Windows/00check.log>;
Status: 1 NOTE
Debian: <https://win-builder.r-project.org/incoming_pretest/add2pkg_0.2.1_20200113_095008/Debian/00check.log>;
Status: 1 NOTE
 

 
No strong reverse dependencies to be checked.
 
Best regards,
CRAN teams' auto-check service

Flavor: r-devel-linux-x86_64-debian-gcc, r-devel-windows-ix86+x86_64
Check: CRAN incoming feasibility, Result: NOTE
  Maintainer: 'Jiaxiang Li <alex.lijiaxiang@foxmail.com>'
 
  New submission
 
  Found the following (possibly) invalid file URI:
    URI: CODE_OF_CONDUCT.md
      From: README.md
```

# 附录 {-}

# 参考文献 {-}
